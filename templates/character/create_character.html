<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Character</title>
    <link rel="stylesheet" href="/static/common.css">
    <link rel="stylesheet" href="/static/character/character_create.css">
    <script>
        let currentTab = 0;
        const classDescriptions = {
            {{range .CharacterClasses}}
            {{.ID}}: {
                name: "{{.Name}}",
                hitPoint: {{.HitPoint}},
                perception: "{{.Perception}}",
                fortitude: "{{.Fortitude}}",
                reflex: "{{.Reflex}}",
                will: "{{.Will}}",
                unarmedArmor: "{{.UnarmedArmor}}",
                lightArmor: "{{.LightArmor}}",
                mediumArmor: "{{.MediumArmor}}",
                heavyArmor: "{{.HeavyArmor}}",
                unArmedWeapon: "{{.UnArmedWeapon}}",
                commonWeapon: "{{.CommonWeapon}}",
                martialWeapon: "{{.MartialWeapon}}"
            },
            {{end}}
        };

        const raceDescriptions = {
            {{range .Races}}
            {{.ID}}: {
                name: "{{.Name}}",
                description: "{{.Description}}",
                hitPoint: {{.HitPoint}},
                size: "{{.Size}}",
                speed: {{.Speed}},
                abilityBoost: {{.AbilityBoost}},
                attributeFlaw: "{{if .AttributeFlaw}}{{.AttributeFlaw}}{{else}}None{{end}}",
                language: "{{.Language}}"
            },
            {{end}}
        };

        const ancestryDescriptions = {
            {{range .Ancestries}}
            {{.ID}}: {
                name: "{{.Name}}",
                description: "{{.Description}}",
                raceId: "{{.RaceID}}"
            },
            {{end}}
        };

        const backgroundDescriptions = {
            {{range .Backgrounds}}
            {{.ID}}: {
                name: "{{.Name}}",
                description: "{{.Description}}",
            },
            {{end}}
        };


        const raceAncestries = {};

        {{range .Ancestries}}
        if (!raceAncestries[{{.RaceID}}]) {
            raceAncestries[{{.RaceID}}] = [];
        }
        raceAncestries[{{.RaceID}}].push({{.ID}});
        {{end}}

        function showTab(n) {
            const tabs = document.querySelectorAll('.tab');
            const tabButtons = document.querySelectorAll('.tab-button');

            tabs.forEach((tab, index) => {
                tab.style.display = index === n ? 'block' : 'none';
                tabButtons[index].classList.toggle('active', index === n);
            });

            currentTab = n;
        }

        function selectClass(classId) {
            // Удаляем активный класс с предыдущего выбранного элемента
            const classItems = document.querySelectorAll('.class-item');
            classItems.forEach(item => item.classList.remove('active'));

            // Добавляем активный класс к текущему выбранному элементу
            const selectedItem = document.querySelector(`.class-item[data-id='${classId}']`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            document.getElementById('character_class_id').value = classId;
            const classInfo = classDescriptions[classId];
            document.getElementById('classDescription').innerHTML = `
                <h3>${classInfo.name}</h3>
                <p><span class="highlight">HIT POINTS</span> ${classInfo.hitPoint}</p>
                <p><span class="highlight">PERCEPTION</span> ${classInfo.perception}</p>
                <p><span class="highlight">FORTITUDE</span> ${classInfo.fortitude}</p>
                <p><span class="highlight">REFLEX</span> ${classInfo.reflex}</p>
                <p><span class="highlight">WILL</span> ${classInfo.will}</p>
                <p><span class="highlight">UNARMED ARMOR</span> ${classInfo.unarmedArmor}</p>
                <p><span class="highlight">LIGHT ARMOR</span> ${classInfo.lightArmor}</p>
                <p><span class="highlight">MEDIUM ARMOR</span> ${classInfo.mediumArmor}</p>
                <p><span class="highlight">HEAVY ARMOR</span> ${classInfo.heavyArmor}</p>
                <p><span class="highlight">UNARMED WEAPON</span> ${classInfo.unArmedWeapon}</p>
                <p><span class="highlight">COMMON WEAPON</span> ${classInfo.commonWeapon}</p>
                <p><span class="highlight">MARTIAL WEAPON</span> ${classInfo.martialWeapon}</p>
            `;
        }

        function selectRace(raceId) {
            // Удаляем активный класс с предыдущего выбранного элемента
            const raceItems = document.querySelectorAll('.race-item');
            raceItems.forEach(item => item.classList.remove('active'));

            // Добавляем активный класс к текущему выбранному элементу
            const selectedItem = document.querySelector(`.race-item[data-id='${raceId}']`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }

            // Обновляем скрытое поле и описание
            document.getElementById('race_id').value = raceId;
            const raceInfo = raceDescriptions[raceId];
            document.getElementById('raceDescription').innerHTML = `
                <h3>${raceInfo.name}</h3>
                <p>${raceInfo.description}</p>
                <p><span class="highlight">Hit Points</span> ${raceInfo.hitPoint}</p>
                <p><span class="highlight">Size</span> ${raceInfo.size}</p>
                <p><span class="highlight">Speed</span> ${raceInfo.speed}</p>
                <p><span class="highlight">Ability Boost</span> ${raceInfo.abilityBoost}</p>
                <p><span class="highlight">Attribute Flaw</span> ${raceInfo.attributeFlaw}</p>
                <p><span class="highlight">Language</span> ${raceInfo.language}</p>
            `;
            updateAncestryList(raceId);
        }

        function clearAncestryDisplay() {
            // Очищаем список наследий
            const ancestryList = document.querySelector('.ancestry-list');
            if (ancestryList) {
                ancestryList.innerHTML = '';
            }

            // Очищаем описание наследия
            const ancestryDescription = document.getElementById('ancestryDescription');
            if (ancestryDescription) {
                ancestryDescription.innerHTML = 'Select an ancestry to see its details.';
            }
        }

        function updateAncestryList(raceId) {
            clearAncestryDisplay();
            const ancestryList = document.querySelector('.ancestry-list');
            const validAncestries = raceAncestries[raceId];
            validAncestries.forEach(ancestryId => {
                const ancestryInfo = ancestryDescriptions[ancestryId];
                const ancestryItem = document.createElement('div');
                ancestryItem.className = 'ancestry-item';
                ancestryItem.setAttribute('data-id', ancestryId);
                ancestryItem.onclick = () => selectAncestry(ancestryId);
                ancestryItem.textContent = ancestryInfo.name;
                ancestryList.appendChild(ancestryItem);
            });
        }

        function selectAncestry(ancestryId) {
            const ancestryItems = document.querySelectorAll('.ancestry-item');
            ancestryItems.forEach(item => item.classList.remove('active'));
            const selectedItem = document.querySelector(`.ancestry-item[data-id='${ancestryId}']`);
            if (selectedItem) {
                selectedItem.classList.add('active')
            }

            document.getElementById('ancestry_id').value = ancestryId;
            const ancestryInfo = ancestryDescriptions[ancestryId];
            document.getElementById('ancestryDescription').innerHTML = `
                <h3>${ancestryInfo.name}</h3>
                <p>Description: ${ancestryInfo.description}</p>
            `;
        }

        function selectBackground(backgroundId) {
            const backgroundItems = document.querySelectorAll('.background-item');
            backgroundItems.forEach(item => item.classList.remove('active'));
            const selectedItem = document.querySelector(`.background-item[data-id='${backgroundId}']`);
            if (selectedItem) {
                selectedItem.classList.add('active')
            }

            document.getElementById('background_id').value = backgroundId;
            const backgroundInfo = backgroundDescriptions[backgroundId];
            document.getElementById('backgroundDescription').innerHTML = `
                <h3>${backgroundInfo.name}</h3>
                <p>Description: ${backgroundInfo.description}</p>
            `;
        }

        async function createCharacter(event) {
            event.preventDefault();

            const characterData = {
                name: document.getElementById('name').value,
                alias: document.getElementById('alias').value,
                last_name: document.getElementById('last_name').value,
                character_class_id: parseInt(document.getElementById('character_class_id').value),
                ancestry_id: parseInt(document.getElementById('ancestry_id').value),
                background_id: parseInt(document.getElementById('background_id').value),
                race_id: parseInt(document.getElementById('race_id').value)
            };

            try {
                const response = await fetch('/character/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(characterData)
                });

                if (response.ok) {
                    alert('Character created successfully!');
                    window.location.href = '/character';
                } else {
                    const errorData = await response.json();
                    alert('Error creating character: ' + errorData.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while creating the character.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            clearAncestryDisplay();
            showTab(currentTab);
        });
    </script>
</head>
<body>
<h1>Create New Character</h1>
<div class="tab-buttons">
    <div class="tab-button" onclick="showTab(0)">Class</div>
    <div class="tab-button" onclick="showTab(1)">Race</div>
    <div class="tab-button" onclick="showTab(2)">Ancestry</div>
    <div class="tab-button" onclick="showTab(3)">Background</div>
    <div class="tab-button" onclick="showTab(4)">Name</div>
</div>
<form id="createCharacterForm" onsubmit="createCharacter(event)">
    <div class="tab" id="classTab">
        <div class="container">
            <div class="class-list">
                {{range .CharacterClasses}}
                <div class="class-item" data-id="{{.ID}}" onclick="selectClass({{.ID}})">{{.Name}}</div>
                {{end}}
            </div>
            <div class="description" id="classDescription">
                Select a class to see its details.
            </div>
        </div>
        <input type="hidden" id="character_class_id" name="character_class_id" required>
    </div>
    <div class="tab" id="raceTab">
        <div class="container">
            <div class="race-list">
                {{range .Races}}
                <div class="race-item" data-id="{{.ID}}" onclick="selectRace({{.ID}})">{{.Name}}</div>
                {{end}}
            </div>
            <div class="description" id="raceDescription">
                Select a race to see its details.
            </div>
        </div>
        <input type="hidden" id="race_id" name="race_id" required>
    </div>
    <div class="tab" id="ancestryTab">
        <div class="container">
            <div class="ancestry-list">
                {{range .Ancestries}}
                <div class="ancestry-item" data-id="{{.ID}}" onclick="selectAncestry({{.ID}})">{{.Name}}</div>
                {{end}}
            </div>
            <div class="description" id="ancestryDescription">
                Select an ancestry to see its details.
            </div>
        </div>
        <input type="hidden" id="ancestry_id" name="ancestry_id" required>
    </div>
    <div class="tab" id="backgroundTab">
        <div class="container">
            <div class="background-list">
                {{range .Backgrounds}}
                <div class="background-item" data-id="{{.ID}}" onclick="selectBackground({{.ID}})">{{.Name}}</div>
                {{end}}
            </div>
            <div class="description" id="backgroundDescription">
                Select a background to see its details.
            </div>
        </div>
        <input type="hidden" id="background_id" name="background_id" required>
    </div>
    <div class="tab" id="nameTab">
        <div class="form-group">
            <label for="name" class="form-label">Name:</label>
            <input type="text" id="name" name="name" class="form-input" required>
        </div>
        <div class="form-group">
            <label for="alias" class="form-label">Alias:</label>
            <input type="text" id="alias" name="alias" class="form-input">
        </div>
        <div class="form-group">
            <label for="last_name" class="form-label">Last Name:</label>
            <input type="text" id="last_name" name="last_name" class="form-input">
        </div>
        <div class="form-buttons">
            <button type="button" class="button-prev" onclick="prevTab()">Previous</button>
            <button type="submit" class="button-submit">Create Character</button>
        </div>
    </div>
</form>
</body>
</html>
